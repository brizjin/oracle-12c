        Патч Технологического Ядра

ВНИМАНИЕ!

Данная версия ТЯ может быть установлена на платформу Oracle 11 (версия не ниже
11.2.0.2) и Oracle 12c (версия не ниже 12.1.0.2), с учетом требований к версии 
Oracle со стороны прикладной Системы, указанных в сопроводительных документах к 
процессу установки прикладной Системы.

С версии ТЯ 7.3.1.0 внешние процессы LOCK_INFO не используются (см. PLPLUS\lockinfo.txt).

С данным ядром должны использоваться следующие версии АРМов

ЦФТ-Навигатор                       - 6.0.118.13 (Novo118_13.exe) и выше
Администратор словаря данных        - 6.332.0.154(Admin332_154.exe) и выше
Администратор проектов              - 6.93.0.127 (Pick93_127.exe) и выше
Администратор доступа               - 6.86.0.51  (UAdm86_51.exe) и выше
Администратор дистрибутива          - 6.19.0.38  (PjAdm19_38.exe) и выше
Администратор персональных данных   - 6.3.0.18   (PdAdm03_018.exe) и выше
Генератор экспорта данных           - 6.32.0.14  (GenExp32_14.exe) и выше
Рабочее место ревизора 				- 6.20.0.27  (Audit20_27.exe) и выше
Редактор экранных форм              - 6.55.0.2 и выше

Получить данные АРМы можно на сайте поддержки http://support.cft.ru.

При использовании продукта Платформа 2 MCA с данной версией ТЯ должен 
использоваться JAVA-компилятор версии 7.3.12 и выше и СП Платформы 2 MCA версии 2.42.28 и выше.


*** Процедура проведения обновления

Краткую инструкцию по проведению обновления смотрите в файле DOC\patch.txt

1. В качестве серверных платформ Oracle 11 и Oracle 12c подразумеваются платформы Oracle Server 
версий не ниже 11.2.0.2. и 12.1.0.2 соответственно, с учетом требований к версии Oracle со 
стороны прикладной Системы, указанных в сопроводительных документах к процессу установки 
прикладной Системы. 
  Для серверной платформы Oracle 11 необходима обязательная установка компоненты Oracle XML DB.

  В качестве клиентской рабочей станции рекомендуется платформа WINDOWS 7 SP1
и выше с установленным Oracle Client версии указанной для АРМа «Администратор проектов» 
в разделе «ПО устанавливаемое на рабочие станции» инструкции «Установка клиентского места».

  Установка патча осуществляется только на указанных платформах, использование
других не гарантирует нормальной работы как всей схемы IBSO, так и скриптов
PATCH в частности. 

2. Перед запуском обновления с рабочей станции необходимо убедиться, что
на рабочей станции установлены следующие утилиты ORACLE : sqlplus.exe, sqlldr.exe, exp.exe, imp.exe;
а также прописан путь (PATH) для их запуска в текущем ENVIRONMENT.
Также необходимо убедиться, что соединение с БД нормально устанавливается
через SQL*Plus как со схемой-владельцем, так и со схемой SYS. При этом
в SQL*Plus должны выставиться define-переменные, отражающие версию БД
(в частности, _O_RELEASE), которые можно посмотреть командой DEF (эти
переменные могут не выставляться в случае, когда состояние учетной
записи Oracle для схемы-владельца имеет статус EXPIRED GRACE).
  Необходимо убедиться, что используется кодировка CL8MSWIN1251 активного
клиента Oracle (который указан первым в системном пути запуска приложений
PATH), иначе сообщения в русской кодировке текстов пакетов будут
неправильно установлены в БД.

 Внимание !!!
 В состав клиента Oracle 11.2 и выше не включается GUI версия утилиты Sql*Plus
 (sqlplusw.exe), поэтому при выполнении PATCH используется ТОЛЬКО консольная 
 версия Sql*Plus (sqlplus.exe). 
 Для корректного отображения символов кириллицы в кодовой странице 1251 
 при работе sqlplus.exe рекомендуется сделать следующее:
 1) Указать в настройках реестра кодовую страницу 1251 в качестве умолчательной 
   для консольных приложений;подробнее об этом см. техническую документацию
   по операционной системе, установленной на клиентской рабочей станции.

   Например, для WINDOWS требуется изменить умолчательное значение (866) 
   параметра реестра:
   HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Nls\CodePage\OEMCP
   на значение 1251 и перезагрузить рабочую станцию;

 2) Использовать в окне командной строки шрифт Lucida Console;


  Нужно также проверить, что на инстансе Oracle в стартовом инициализационном
файле Oracle - init<SID>.ora для системного параметра AUDIT_TRAIL задано одно
из значений:
- DB - для использования журнала аудита базы данных в стандартном режиме; 
- DB, EXTENDED - для включения расширенного режима (в данном режиме в качестве
дополнения в журнал аудита записываются исполняемые SQL команды, или значения
переменных привязки, если таковые имеются).
Если значение параметра не установлено, то его нужно установить и перезапустить
экземпляр Oracle.

  Перед запуском обновления все работы со схемой-владельцем должны быть 
остановлены. Это означает, что все пользовательские сессии должны быть удалены,
остановлены все задания по расписанию, а также должен быть закрыт вход в 
систему пользователям, кроме SYS, владельца IBSO, владельца AUD и владельца 
AUDM. Рекомендуются следующие способы закрытия БД от нежелательных соединений
пользователей:
- Перезапуск прослушивателя (listener-а) на другом порту для обновляемой БД,
  временное исключение БД из сервиса GLOBAL_NAMES.
- Временная блокировка учетных записей пользователей Oracle (кроме SYS, AUD,
  AUDM, владельца IBSO).
- Останов основной базы, проведение обновления на ее копии на момент останова
  (никому не доступной), затем в случае успеха - копирование обновленной
  копии на место основной базы.
После проведения обновления учетные записи пользователей и прослушиватель
нужно вернуть к исходному состоянию до обновления.

Чтобы не компрометировать пароли в передаваемых в качестве параметров командной
строки командным скриптам *.BAT строк соединения с БД (т.к. многие командные
оболочки, например, FAR-manager, сохраняют историю выполняемых команд),
рекомендуется запускать отдельные окна командного интерпретатора, в которых
и выполнять командные скрипты *.BAT.

3. Раздача необходимых привилегий пользователю-владельцу схемы IBSO
осуществляется с помощью patch_sys.bat с указанием в качестве параметра 
коннект-строки к схеме SYS, при этом работа пользователей и заданий должна быть
остановлена. Допускается вызов скрипта в режиме "без вопросов" (см. пункт 1 
раздела Замечания).

4. Обновление схемы менеджера аудита (AUDM) необходимо выполнить с помощью
скрипта patch_audm.bat с указанием в качестве параметра коннект-строки к схеме 
SYS, при этом работа пользователей и заданий должна быть остановлена. Перед 
обновлением выполняется проверка возможности установки патча. Если текущая 
версия ТЯ не позволяет выполнить патч, то обновление не будет выполнено.
Допускается вызов скрипта в режиме "без вопросов" (см. пункт 1 раздела 
Замечания).

5. Обновление схемы ревизора (AUD) необходимо выполнить с помощью скрипта 
patch_aud.bat с указанием в качестве параметра коннект-строки к схеме-ревизора
AUD, при этом работа пользователей и заданий должна быть остановлена. Перед 
обновлением выполняется проверка возможности установки патча. Если текущая 
версия ТЯ не позволяет выполнить патч, то обновление не будет выполнено. 
Допускается вызов скрипта в режиме "без вопросов" (см. пункт 1 раздела 
Замечания).

6. Обновление схемы-владельца осуществляется с помощью patch_ibs.bat с 
указанием в качестве параметра коннект-строки к схеме-владельцу. 
Перед его выполнением нужно остановить все работы со схемой - удалить
все пользовательские сессии, заблокировать все задания в очереди заданий 
Oracle, остановить сервера RUNPROC и FORMON (если они запущены). Также нужно 
убедиться что предыдущие этапы (2-5) завершились успешно, проанализировав 
полученные log-файлы. Перед обновлением выполняется проверка возможности
установки патча. Если текущая версия ТЯ не позволяет выполнить патч, то 
обновление не будет выполнено. Допускается вызов скрипта в режиме "без вопросов"
(см. пункт 1 раздела Замечания).

  6.1. Если на схеме используется продукт Платформа 2 MCA и версия JAVA-компилятора 
  не удовлетворяет требованиям, указанным выше в этом документе, то после 
  обновления ТЯ необходимо установить требуемую версию JAVA-компилятора.
  Проверить наличие и версию JAVA-компилятора на схеме можно, выполнив следующий
  запрос на схеме владельца: 
	  select plp2java.get_version from dual 
  Функция возвращает версию JAVA-компилятора. Если функция возвращает пустое 
  значение, то JAVA-компилятор не установлен.
  JAVA-компилятор доступен на сайте поддержки http://support.cft.ru.

7. Исполняемый файл getlog.bat упаковывает полученные логи в архив logs.zip.
Для его успешной отработки необходимо, чтобы путь к PKZIP.EXE был в PATH или
сам PKZIP находился в одном каталоге с getlog.bat.
В качестве альтернативной программы архиватора, можно использовать 7z. 
Исполняемый файл getlog7z.bat упаковывает полученные логи в архив logs.zip.
Для его успешной отработки необходимо, чтобы путь к 7Z.exe был в PATH или
сам 7Z.exe находился в одном каталоге с getlog7z.bat.

8. После проведения процедуры обновления необходимо установить лицензионную 
информацию. Для этого достаточно обновить описание приложения "ЦФТ-Платформа 
Развития". Инструкцию по установке лицензионной информации см. в файле 
DOC\license_setup.txt

Рекомендуется проверить, что время запуска служебного задания проверки
лицензионной информации установлено таким образом, чтобы во время выполнения
задания не запускались процедуры, требующие останова схемы. 

9. Рекомендуется проверить, что периодичность запуска задания "Обновление 
системных пайп" находится в интервале от 120 до 300 минут.

10.После проведения процедуры обновления необходимо также выполнить установку
сопутствующих системных типов и операций, которые находятся в каталоге MDB 
корневой папки. Описание установки хранилищ с системными типами находится 
в файле PATCH\MDB\readme.txt.

11.Рекомендуется запустить диагностический скрипт UTILS\dubl_rek.sql для поиска ТБП,
в которых несколько реквизитов ссылаются на одну колонку таблицы ТБП.
Если такие ТБП существуют, то это может привести к некорректной работе бизнес-логики,  
перестроение таблицы для таких ТБП также может завершиться аварийно.
--------------------------------------------------------------------------------
Замечания.

1) Исполняемые сценарии: patch_sys.bat, patch_audm.bat, patch_aud.bat и 
   patch_ibs.bat можно запустить в режиме "без вопросов" (quiet/silent mode), 
   т.е. без запросов-подтверждений параметров UPGRADE (используются параметры 
   по умолчанию и имена табличных пространств из файла настроек usr_sets.sql).
   Этот режим указывается опцией командной строки "/q", задаваемой последним 
   параметром.


--------------------------------------------------------------------------------
Рекомендации по анализу логов обновления ТЯ.

1) В логах схемы-владельца не должно быть ошибок, связанных
с запуском сервиса LOCK_INFO вида:

ORA-20300: APP-RTL: LOCK-SUBMIT: Процесс LOCK_INFO был поставлен в очередь
04:45:11 16/08/08.
Номер задания 33956, пользователь - IBS.
LOCK-LIMIT: Задание не было активизировано, возможно, из-за того, что
лимит на количество фоновых (BACKGROUND) процессов исчерпан.
Нужно увеличить этот лимит или запустить LOCK_INFO в отдельной сессии.

Также критична ошибка:
ORA-01017: неверно имя пользователя/пароль; вход в систему запрещается.

2) Требуется проанализировать все файлы с логами на предмет характера
возникавших ошибок Oracle (искать файлы с вхождениями подстроки "ORA-").
Некритичные ошибки (см. ниже) можно пропускать.

Приложение 1. Список критичных ошибок, наличие которых говорит, что обновление
с большой вероятностью не завершено.

ORA-3113 - разрыв соединения с СУБД, потеряна связь с сервером.

Ошибки связанные с нехваткой места в табличных пространствах:

ORA-1652  - нехватка места во временном табличном пространстве;
ORA-1653  - нехватка места для размещения таблицы;
ORA-1654  - нехватка места для размещения индекса.

ORA-600, ORA-7445 - внутренние ошибки Oracle. Необходимо обратиться в 
сопровождение Oracle.

Приложение 2. Некритичные ошибки в логах обновления.

Для каждой из ошибок ниже приводится перечень SQL Statement, при
выполнении которых ошибки можно считать некритичными:

ORA-00001: нарушено ограничение уникальности
insert

ORA-00942: таблица или представление пользователя не существует
drop table, drop view

ORA-04043: объект XXXX не существует
drop package

ORA-00955: name is already used by an existing object
create table, create index, create function

ORA-01418: заданного индекса не существует
drop index

ORA-01430: добавляемый столбец уже существует в таблице
alter table add column

ORA-01920
create user

ORA-01952: system privileges not granted to ...
revoke

ORA-02260: в таблице может быть задан только один первичный ключ
создание primary key

ORA-02264: это имя уже используется в существующем ограничении
alter table add constraint (check constraint)

ORA-02275: такое ссылочное ограничение уже есть в таблице
alter table add constraint

ORA-02443: Невозможно удалить ограничение - ограничение не существует
alter table drop constraint

ORA-04080: триггер XXXX не существует
alter trigger disable
alter trigger compile
drop trigger
