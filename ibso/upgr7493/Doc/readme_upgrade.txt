        Обновление технологического ядра до версии 7.4.

ВНИМАНИЕ!

Данная версия ТЯ может быть установлена на платформу Oracle 11 (версия не ниже
11.2.0.2) и Oracle 12c (версия не ниже 12.1.0.2), с учетом требований к версии 
Oracle со стороны прикладной Системы, указанных в сопроводительных документах к 
процессу установки прикладной Системы.

С версии ТЯ 7.3.1.0 внешние процессы LOCK_INFO не используются (см. PLPLUS\lockinfo.txt).

С данным ядром должны использоваться следующие версии АРМов

ЦФТ-Навигатор                       - 6.0.118.13 (Novo118_13.exe) и выше
Администратор словаря данных        - 6.332.0.154(Admin332_154.exe) и выше
Администратор проектов              - 6.93.0.127 (Pick93_127.exe) и выше
Администратор доступа               - 6.86.0.51  (UAdm86_51.exe) и выше
Администратор дистрибутива          - 6.19.0.38  (PjAdm19_38.exe) и выше
Администратор персональных данных   - 6.3.0.18   (PdAdm03_018.exe) и выше
Генератор экспорта данных           - 6.32.0.14  (GenExp32_14.exe) и выше
Рабочее место ревизора 				- 6.20.0.27  (Audit20_27.exe) и выше
Редактор экранных форм              - 6.55.0.2 и выше


Получить данные АРМы можно на сайте поддержки http://support.cft.ru.

При использовании продукта Платформа 2 MCA с данной версией ТЯ должен 
использоваться JAVA-компилятор версии 7.3.12 и выше и СП Платформы 2 MCA версии 2.42.28 и выше.


*** Процедура проведения обновления

Краткую инструкцию по проведению обновления смотрите в файле DOC\upgrade.txt

В каталоге PATCH находятся скрипты для установки последних изменений ТЯ. 
Если уже установлена ТЯ версии 7.3.2.1 или выше, то полностью выполнять весь 
UPGRADE не обязательно, достаточно выполнить патч до текущей версии.
Порядок и условия установки патча описан в файле DOC\patch.txt.

1. При переносе файлов каталога UPGRADE нужно сохранить используемую
структуру каталогов.
  
  В качестве серверных платформ Oracle 11 и Oracle 12c подразумеваются платформы Oracle Server 
версий не ниже 11.2.0.2. и 12.1.0.2 соответственно, с учетом требований к версии Oracle 
со стороны прикладной Системы, указанных в сопроводительных документах к процессу установки 
прикладной Системы.
  Для серверной платформы Oracle 11 необходима обязательная установка компоненты Oracle XML DB.

  В качестве клиентской рабочей станции рекомендуется платформа WINDOWS 7 SP1
и выше с установленным Oracle Client версии указанной для АРМа «Администратор проектов» 
в разделе «ПО устанавливаемое на рабочие станции» инструкции «Установка клиентского места».

  UPGRADE осуществляется только на указанных платформах, использование
других не гарантирует нормальной работы как всей схемы IBSO, так и скриптов
UPGRADE в частности.

2. Перед запуском UPGRADE с рабочей станции необходимо убедиться, что
на рабочей станции установлены следующие утилиты ORACLE :
    sqlplus.exe, sqlldr.exe, exp.exe,
    imp.exe; 
а также прописан путь (PATH) для их запуска в текущем ENVIRONMENT.
Также необходимо убедиться, что соединение с БД нормально устанавливается
через SQL*Plus как со схемой-владельцем, так и со схемой SYS. При этом
в SQL*Plus должны выставиться define-переменные, отражающие версию БД
(в частности, _O_RELEASE), которые можно посмотреть командой DEF (эти
переменные могут не выставляться в случае, когда состояние учетной
записи Oracle для схемы-владельца имеет статус EXPIRED GRACE).
  Необходимо убедиться, что используется кодировка CL8MSWIN1251 активного
клиента Oracle (который указан первым в системном пути запуска приложений
PATH), иначе сообщения в русской кодировке текстов пакетов будут
неправильно установлены в БД.

 Внимание !!!
 В состав  клиента Oracle 11.2 и выше не включается GUI версия утилиты Sql*Plus
 (sqlplusw.exe), поэтому при выполнении UPGRADE используется ТОЛЬКО консольная 
 версия Sql*Plus (sqlplus.exe). 
 Для корректного отображения символов кириллицы в кодовой странице 1251 
 при работе sqlplus.exe рекомендуется сделать следующее:
 1) Указать в настройках реестра кодовую страницу 1251 в качестве умолчательной 
   для консольных приложений;подробнее об этом см. техническую документацию
   по операционной системе, установленной на клиентской рабочей станции.

   Например, для WINDOWS требуется изменить умолчательное значение (866) 
   параметра реестра:
   HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Nls\CodePage\OEMCP
   на значение 1251 и перезагрузить рабочую станцию;

 2) Использовать в окне командной строки шрифт Lucida Console;

  Нужно также проверить, что на инстансе Oracle в стартовом инициализационном
файле Oracle - init<SID>.ora для системного параметра AUDIT_TRAIL задано одно
из значений:
- DB - для использования журнала аудита базы данных в стандартном режиме; 
- DB, EXTENDED - для включения расширенного режима (в данном режиме в качестве
дополнения в журнал аудита записываются исполняемые SQL команды, или значения
переменных привязки, если таковые имеются).
Если значение параметра не установлено, то его нужно установить и перезапустить
экземпляр Oracle.

  Перед запуском UPGRADE все работы со схемой-владельцем должны быть 
остановлены. Это означает, что все пользовательские сессии должны быть удалены,
остановлены все задания по расписанию (в т.ч. системные процессы LOCK_INFO и
AUD_MGR), а также должен быть закрыт вход в систему пользователям, кроме SYS,
владельца IBSO, владельца AUD и владельца AUDM.
Рекомендуются следующие способы закрытия БД от нежелательных соединений
пользователей:
- Перезапуск прослушивателя (listener-а) на другом порту для обновляемой БД,
  временное исключение БД из сервиса GLOBAL_NAMES.
- Временная блокировка учетных записей пользователей Oracle (кроме SYS,AUD,AUDM,
  владельца IBSO).
- Останов основной базы, проведение UPGRADE на ее копии на момент останова
  (никому не доступной), затем в случае успеха - копирование обновленной
  копии на место основной базы.
Не рекомендуется использовать режим RESTRICTED SESSION, т.к. во время
выполнения UPGRADE на определенных его этапах запускается сервис lOCK_INFO,
без которого невозможно выполнение ряда действий.
После проведения UPGRADE учетные записи пользователей и прослушиватель
нужно вернуть к исходному состоянию до UPGRADE.
  Если требуется изменить предлагаемые по умолчанию имя владельца IBSO (IBS),
имя схемы менеджера аудита (AUDM) и имена табличных пространств, нужно 
переименовать подходящий файл _usr_sets1.sql или _usr_sets2.sql (см. примечание
в этих файлах) в usr_sets.sql и, если необходимо, изменить в нем соответствующие
настройки.
Чтобы не компрометировать пароли в передаваемых в качестве параметров командной
строки командным скриптам *.BAT строк соединения с БД (т.к. многие командные
оболочки, например, FAR-manager, сохраняют историю выполняемых команд),
рекомендуется запускать отдельные окна командного интерпретатора, в которых
и выполнять командные скрипты *.BAT.

3. UPGRADE схем ревизора (AUD), менеджера аудита (AUDM), предоставление
привилегий схеме-владельцу IBSO необходимо выполнить с помощью FIRST.BAT
(нужно указать 2 обязательных параметра - коннект-строку к схеме SYS
и схеме-ревизора AUD, а также опциональный параметр MENU, если требуется
выполнить нестандартную настройку схемы AUD через меню обновления схемы AUD),
при этом работа пользователей и заданий должны быть остановлены.

  3.1. Перед запуском обновления проводится проверка возможности установки 
  патча. Если текущая версия ТЯ и версия схемы ревизора (AUD) позволяют 
  выполнить патч, то будет предложено выбрать- продолжить или прекратить 
  выполнение апгрейда. По умолчанию будет продолжено выполнение апгрейда.

Будут запрошены имена табличных пространств по умолчанию и временного для
создаваемых пользователей, параметры хранения таблиц и индексов
в схеме-ревизора, а также имя пользователя-владельца IB-System-Object, для
которого создается схема-ревизор и менеджер аудита, и ограничение на количество
Oracle accounts для сервера приложений (если предполагается его использование,
то нужно задать значение, большее 0, рекомендуется 1). Дополнительное описание
по обновлению схемы-ревизора (AUD) находится в файле readme.txt подкаталога
AUDIT. Дополнительное описание по обновлению и управлению менеджером аудита
(AUDM) находится в файле readme.txt подкаталога AUDMGR.

4. Если предполагается разделение ряда прикладных таблиц на секции
(partitions) во время проведения UPGRADE, тогда нужно до проведения
основного этапа UPGRADE занести информацию о разделяемых таблицах
в таблицу CLASS_PARTITIONS, предварительно создав ее с помощью
запуска из-под SQL*Plus на схеме-владельце IBSO скрипта cls_prt.sql
из подкаталога V5X. Порядок заполнения таблицы описан в readme.txt
подкаталога tbl. Если исходная версия равна 5.1 или выше, то выполнение
этого этапа не обязательно (таблица CLASS_PARTITIONS уже будет
присутствовать).


5. UPGRADE схемы-владельца осуществляется с помощью UPGR.BAT или UPGR_.BAT
(c перестроением  таблиц и без перестроения, соответственно) с указанием 
в качестве параметра коннект-строки к схеме-владельцу. Перед его выполнением
нужно остановить все работы со схемой - удалить все пользовательские сессии,
заблокировать все задания в очереди заданий Oracle, остановить сервера RUNPROC и
FORMON (если они запущены). Также нужно убедиться что предыдущие этапы (3-5) 
завершились успешно, проанализировав полученные log-файлы. 

  5.1. Если на схеме используется продукт Платформа 2 MCA и версия JAVA-компилятора
  не удовлетворяет требованиям, указанным выше в этом документе, то после 
  обновления ТЯ необходимо установить требуемую версию JAVA-компилятора.
  Проверить наличие и версию JAVA-компилятора на схеме можно, выполнив следующий
  запрос на схеме владельца: 
	  select plp2java.get_version from dual 
  Функция возвращает версию JAVA-компилятора. Если функция возвращает пустое 
  значение, то JAVA-компилятор не установлен.
  JAVA-компилятор доступен на сайте поддержки http://support.cft.ru.

Перед выполнением UPGRADE запрашиваются следующие параметры:

- Start UPGRADE from Old IBSO Version
  исходная версия технологического ядра IBSO (по умолчанию предлагается та,
  которая установлена, однако ее можно изменить) для определения 
  версионно-зависимых этапов UPGRADE;

- Default Tablespace for Tables
  Default Tablespace for Indexes
  Default Tablespace for Lobs
  Archive Tablespace for Tables
  Archive Tablespace for Indexes
  Tablespace for Dictionary Tables
  Tablespace for Dictionary Indexes

  имена пользовательских табличных пространств для прикладных таблиц и таблиц
  словаря IBSO, для индексов на прикладных таблицах и таблицах словаря, для
  архивных секций на прикладных таблицах (по умолчанию предлагаются табличные
  пространства, определенные в файле настроек usr_sets.sql, если настройки 
  не заданы, то используются имена табличных пространств USERS, IDX и PART,
  соответственно), при этом если эти имена уже были сохранены в БД, то 
  сохраненные имена перекрывают имена в файле настроек usr_sets.sql;
  Файл настроек usr_sets.sql можно сформировать путем переименования одного
  из прилагаемых шаблонов _usr_sets1.sql или _usr_sets2.sql (см. примечания в
  этих файлах), который наиболее подходит текущему состоянию БД, при 
  необходимости его можно дополнительно отредактировать, изменив соответствующие
  настройки.

- Filling User Rights Context
  признак заполнения системного контекста правами доступа пользователей, 
  по умолчанию используется либо текущее сохраненное в БД значение (если
  существует), либо значение 1 (т.е. контекст доступа заполняется);

- Compilation Only
  признак UPGRADE в упрощенном режиме компиляции. Возможные значения:
  NO  - Полноценный апгрейд. Это значение по-умолчанию.
  YES - Если исходная версия ТЯ 7.3 и выше, то можно указать значение YES. 
        В этом случае будет	проведена только полная перекомпиляция прикладной 
        модели, без обновления объектов ТЯ.
  Если исходная версия ТЯ была 7.1.2 и выше, то можно указать любое другое 
  значение, отличное от YES и NO. В этом случае будут установлены только изменения
  версий 7.2 и выше.

- Grant roles for report packages to users
  признак замены у пользователей прямых грантов на пакеты, используемых
  в отчетах Oracle Reports, на предоставление автоматически создаваемых при
  UPGRADE специальных ролей Oracle (для каждого пакета, используемого
  в отчетах создается отдельная роль). По умолчанию - значение YES.
  При значении YES у пользователей будут изъяты права на пакеты,
  используемые в отчетах и добавлены соответствующие роли, но количество
  грантуемых ролей для пользователя не может превышать 140. Кроме значения
  YES можно также указать конкретное значение ограничения количества
  грантуемых ролей.

- CREATE SYNONYMS in default profile
  значение настройки CREATE_SYNONYMS умолчательного профиля DEFAULT.
  Данная настройка управляет режимом создания синонимов для объектов, 
  используемых в отчетах Oracle Reports, в пользовательских схемах.
  При значении настройки, равном YES, (по умолчанию, соответствует поведению ТЯ
  версий ниже, чем 7.1) синонимы создаются, установка текущей схемы в логон 
  триггере не производится.
  При значении настройки, равном NO, синонимы не создаются,  в логон триггере
  в качестве текущей схемы устанавливается схема владельца IBSO.
  ВНИМАНИЕ!!!
  1) При изменении значения настройки CREATE_SYNONYMS профиля DEFAULT
  в процессе проведения UPGRADE для всех пользователей Oracle будет выполнена
  процедура удаления или пересоздания синонимов и синхронизации прав на объекты
  отчетов;
  этот этап может занимать весьма продолжительное время (до нескольких часов, 
  если пользователей системы доступа большое количество). Если требуется
  пропустить данный этап, то можно указать значение SKIP для данной настройки, 
  если требуется выполнить этот этап в безусловном режиме с уже существующими
  настройками, то можно указать значение FORCE. Отдельно эту процедуру можно 
  выполнить с помощью сценария c_syn.sql из подкаталога utils в составе UPGRADE,
  выполнив его из-под SQL*Plus на схеме-владельце.
  2) После массового удаления синонимов (от нескольких сотен тысяч) могут
  возникнуть проблемы, описанные  в Oracle Bug #6783812 SERVER PROCESS AND SMON 
  HANG WITH 'ENQ: SS - CONTENTION' AND 'SORT SEGMENT REQUEST', 
  и #8493928 IMPROVE PERFORMANCE OF KQLCLO1() FOR LARGE COUNTS OF NON-EXISTENT
  OBJECTS, связанные с тем, что после удаления синонимов выполняется 
  ресурсоемкая чистка удаленных объектов в системном словаре Oracle.
  Исправление данной проблемы, в частности, содержится в обновлении 
  Oracle 8531632. Крайне рекомендуется проверить на тестовой схеме после 
  проведения UPGRADE влияние системного процесса чистки удаленных объектов на
  общую производительность системы.
  3) Удаление синонимов в пользовательских схемах не влияет на выполнение 
  отчетов на сервере отчетов, но при этом не гарантируется  корректная работа 
  шаблонов отчетов в Reports runtime (может потребоваться перекомпиляция 
  шаблонов отчетов с помощью Report Builder).

- Recreate user roles
  признак пересоздания пользовательских ролей в процессе проведения UPGRADE. 
  По умолчанию принимается значение YES, что означает полное удаление и создание
  ролей пользователей с последующей перераздачей этих ролей зарегистрированным 
  пользователям системы доступа. При значении признака NO происходит только
  наполнение ролей необходимыми привилегиями без их перераздачи пользователям
  (предполагается, что роли уже розданы кому необходимо).

- Minimum days amount to keep reports in queue
  При проведении UPGRADE может быть выполнена очистка таблицы результатов
  выполнения отчетов (ORSA_JOBS_OUT).
  Данная настройка определяет минимальный период хранения (в днях) результатов
  выполнения отчетов в очереди отчетов (обрабатываемой агентом сервера отчетов -
  ORSA). По умолчанию используется либо уже сохраненное ранее значение, либо
  значение 90 (если указывается в первый раз). Значение 0 означает признак
  запрета автоматического удаления выполненных отчетов из очереди отчетов.

Для наблюдения происходящих процессов нужно мониторить коммуникационный канал
(PIPE) с именем DEBUG - в него выводится информация в процессе работы скриптов
(монитор рекомендуется запустить сразу после изменения пакетов системного ядра,
то есть после отработки скрипта kernpkg.sql). Дополнительно нужно запустить 
монитор на коммуникационный канал DEBUG0 - в него пишется информация в процессе
создания ограничений целостности и индексов, а также информация о компиляции 
представлений. Поскольку объем выводимой информации в процессе UPGRADE 
достаточно велик, вывод информации из "Монитора коммуникационного канала" нужно
направить на диск.
После установки пакетов ТЯ UPGRADE перейдет в режим ожидания (паузы) для запуска
мониторов на указанные коммуникационные каналы (DEBUG,DEBUG0), - после запуска
мониторов нужно нажать любую клавишу в окне выполнения UPGRADE для его
продолжения.

  Исполняемый файл UPGR_.BAT предназначен для выполнения UPGRADE без
перестроения таблиц (UPGRADE в режиме компиляции), рекомендуется использовать
для исходной версии ТЯ 4.2 и выше, если не требуется перестраивать или 
разделять (выделять архивные секции) таблицы.

  Исполняемый файл UPGR.BAT принимает второй опциональный параметр (первый -
коннект-строка), в котором указывается количество дополнительных параллельных
процессов (максимум 3), в которых будет выполняться перестроение таблиц.
Если параметр не указывается, то перестроение будет осуществляться в одном 
процессе. Если задано более 1 процесса, тогда перед запуском перестроения таблиц
и после их перестроения UPGRADE перейдет в режим ожидания, чтобы в первой паузе
иметь возможность выполнить дополнительные мероприятия по настройке табличных
пространств или подредактировать автоматически созданные скрипты перестроения
таблиц в подкаталоге compile (*.tbl), вторая пауза вводится для того, чтобы
синхронизировать дальнейшее выполнение UPGRADE, т.к. переходить к следующим
этапам можно только после завершения работы всех параллельных процессов,
перестраивающих таблицы. Скрипты для перестроения таблиц в параллельных
процессах формируются автоматически и имеют такие названия <owner>.tbl для 
основного процесса и <owner>-1.tbl, <owner>-2.tbl, <owner>-3.tbl для 
дополнительных. 
Если исходная версия ТЯ ниже, чем 5.0, то по умолчанию в первый дополнительный
процесс включается самая большая таблица, во второй - вторая по величине, 
в третий - третья по величине, остальные в основной процесс. Если исходная 
версия ТЯ 5.0 или выше, тогда набор таблиц для перестроения должен быть 
предварительно явно задан путем заполнения таблицы project (формат заполнения 
описан в файле readme.txt подкаталога tbl).
Если указаны дополнительные процессы, тогда информация о перестроении таблиц
выводится в следующие коммуникационные каналы: DEBUG - для основного процесса;
DEBUG1 - для первого дополнительного; DEBUG2 - для второго; DEBUG3 - для 
третьего; соответственно, на все эти каналы нужно запустить мониторы в момент
паузы перед запуском скриптов перестроения таблиц.

  UPGRADE может быть проведен в режиме параллельной компиляции объектов
прикладной модели исполняемыми файлами UP_.BAT или UP.BAT. При этом необходимо,
чтобы сервер БД имел не менее 4 процессоров. Компиляция в параллельных процессах
существенно уменьшает время общей компиляции по сравнению с однопоточной 
компиляцией, однако этот режим менее стабилен (из-за внутренних ошибок Oracle,
которые изредка возникают при многопоточной компиляции), поэтому он является 
лишь опциональной альтернативой основным сценариям (UPGR_.BAT или UPGR.BAT).
UP_.BAT выполняет UPGRADE только в режиме компиляции (т.е. без перестроения
таблиц, аналогично UPGR_.BAT). UP.BAT позволяет выполнять UPGRADE с 
перестроением таблиц, список которых управляется так же, как и в UPGR.BAT, при 
этом дополнительным параметром может быть указано количество дополнительных 
процессов, перестраивающих таблицы.
Вывод информации при параллельной компиляции осуществляется в коммуникационные
каналы с именами DEBUG, DEBUG1, DEBUG2, DEBUG3 (отдельный канал для каждого из 
4-х процессов), которые нужно запустить тогда же, когда и основные 
коммуникационные каналы DEBUG, DEBUG0.

  Исполняемые сценарии UPGRADE дополнительно могут принимать еще один
опциональный параметр - полный путь к утилите Oramon.exe ("Монитор
коммуникационного канала"). Если это путь указан правильно, то Мониторы
будут автоматически запущены на необходимые коммуникационные каналы
(при этом режим паузы для ручного запуска мониторов будет пропущен).
Для сценариев UPGR_.BAT и UP_.BAT - это второй параметр, для сценариев
UPGR.BAT и UP.BAT - это третий параметр. Путь к утилите Oramon.exe
также может быть указан в файле настроек usr_sets.sql в подстановочной
переменной oramon (заданное значение параметра командной строки перекрывает
значение из файла настроек).
  Исполняемые сценарии UPGRADE в режиме компиляции UPGR_.BAT и UP_.BAT
можно запустить в режиме "без вопросов" (quiet/silent mode), т.е. без
запросов-подтверждений параметров UPGRADE (используются параметры по
умолчанию и имена табличных пространств из файла настроек usr_sets.sql).
Этот режим указывается опцией командной строки "/q", задаваемой третьим
параметром (или вторым, если не указана утилита Oramon, - в этом случае
в выполнении UPGRADE будет инициирована пауза для ручного запуска мониторов).

6. В случае успешного перестроения-конвертации таблиц OBJECT_RIGHTS_LIST,
OBJECT_RIGHTS_EX, OBJ_STATIC (колонки OBJ_ID и ID должны быть сконвертированы
в строковый формат) нужно удалить их старые версии - таблицы
BK_OBJ_RIGHTS_LIST, BK_OBJECT_RIGHTS_EX, BK_OBJ_STATIC, соответственно.

7. Работа скриптов также журналируется - логи пишутся в каталогах LOG,
SQLLDR, COMPILE, U_SOURCE, AUDIT, AUDMGR. Если по каким-либо причинам
полностью UPGRADE не прошел, то после анализа логов можно продолжить
UPGRADE c неудавшегося этапа - в этом случае нужно будет последовательно
запустить не отработавшие скрипты.

8. Хранилище IBSOBJ\IBSOBJ.MDB содержит описание структуры технологического
ядра. После проведения UPGRADE c помощью модуля "Администратор
дистрибутива" можно проверить на соответствие структуры ТЯ с эталонной
из указанного хранилища. Файл 7_X_X_X_sysobj.txt содержит описание индексов
и ограничений целостности эталонного ядра в текстовом виде.
При выполнении UPGRADE создаются списки ошибок в объектах прикладной
модели как перед выполнением UPGRADE, так и после (файлы *.err,*.erc,*.ecr,
err_frm.log, err_ctl.log, файлы ошибок перед UPGRADE помещаются в подкаталог
LOG, после - в подкаталог COMPILE). Их можно использовать в качестве
дополнительного контроля корректности выполнения UPGRADE.

9. После проведения UPGRADE нужно перезапустить задание менеджера
аудита (AUDM) с помощью сценария LAST.BAT, которому в качестве параметра
нужно указать строку соединения со схемой SYS.

10. Исполняемый файл GETLOG.BAT упаковывает полученные логи в архив LOGS.ZIP.
Для его успешной отработки необходимо, чтобы путь к PKZIP.EXE был в PATH или
сам PKZIP находился в одном каталоге с GETLOG.BAT.

11. В каталоге TOOLS\FIO находятся внешние библиотеки (осуществляющие
интерфейс к файловым операциям на сервере) для разных серверных платформ.
Описание установки библиотеки и интерфейса файловых операций находятся
в файлах TOOLS\FIO\fio.txt, TOOLS\FIO\stdio.txt, TOOLS\FIO\dbf.txt
(интерфейс для работы с файлами формата DBF).
Скрипты UPGRADE установку компонент БД для FIO производят автоматически,
после проведения UPGRADE требуется провести установку (или обновление)
только библиотеки для нужной платформы.

12. В каталоге TOOLS\HASH находятся внешние библиотеки (осуществляющие
интерфейс к функциям ключевания) для разных серверных платформ.
Описание установки библиотеки находится в файле TOOLS\HASH\hash.txt.
Скрипты UPGRADE установку компонент БД для HASH производят автоматически,
после проведения UPGRADE требуется провести установку (или обновление)
только библиотеки для нужной платформы.
Если для ключевания файлов ранее использовалась библиотека hashrpc
(основанная на работе через hashbox), то стандартную установку компонент
HASH делать не нужно (обновление следует делать вместе с обновлением
hashbox, которое в UPGRADE не входит).

13. В каталоге TOOLS\VFS находятся скрипты для установки новой версии
виртуальной файловой системы VFS, основанной на BLOB данных в таблицах
Oracle. Может использоваться как транзакционная альтернатива FIO.
Описание установки и интерфейса файловых операций находятся в файлах
TOOLS\VFS\vfs.txt, TOOLS\VFS\vfs_io.txt, TOOLS\VFS\vfs_adm.txt,
TOOLS\VFS\vfs_mgr.txt, TOOLS\VFS\vfs_smgr.txt.
Первичная установка новой версии VFS опциональна, т.е. она устанавливается
по потребности; если VFS уже была установлена ранее, тогда требуется
провести ее переустановку после проведения UPGRADE.

14. В каталоге TOOLS\XML находится инструкция по установке библиотеки для
работы с xml, использующей библиотеки Xerces C++ (Apache Software Foundation)
и ICU (International Business Machines Corporation). Лицензионная информация
находится в каталоге TOOLS\XML\legal. Библиотека частично реализует интерфейс
Oracle XDK. Нереализованные функции пакетов генерируют исключение с текстом
Not implemented. Во время выполнения UPGRADE происходит регистрация внешней
библиотеки libxml и установка пакетов xrc_xmldom и xrc_xmlparser. Отдельно нужно
скопировать саму библиотеку на сервер и настроить листенер. Сделать это
можно как до, так и после проведения UPGRADE.

15. После проведения UPGRADE необходимо установить лицензионную информацию.
Если исходная версия ТЯ 7.1.1.3 и выше, то достаточно обновить описание
приложения "ЦФТ-Платформа Развития".
Инструкцию по установке лицензионной информации см. в файле 
DOC\license_setup.txt.

Рекомендуется настроить время запуска служебного задания проверки
лицензионной информации таким образом, чтобы во время выполнения задания
не запускались процедуры, требующие останова схемы. Подробности см. в файле
DOC\license_report.txt.

16. После проведения UPGRADE необходимо также выполнить установку
сопутствующих системных типов и операций, которые находятся в каталоге
MDB. Описание установки хранилищ с системными типами находится
в файле MDB\readme.txt.

17. Рекомендуется проверить, что периодичность запуска задания "Обновление 
системных пайп" находится в интервале от 120 до 300 минут.

18. Рекомендуется запустить диагностический скрипт UTILS\dubl_rek.sql для поиска ТБП,
в которых несколько реквизитов ссылаются на одну колонку таблицы ТБП.
Если такие ТБП существуют, то это может привести к некорректной работе бизнес-логики,  
перестроение таблицы для таких ТБП также может завершиться аварийно.
--------------------------------------------------------------------------------
Рекомендации по анализу логов обновления ТЯ.

1) Необходимо убедиться в наличии логов от выполнения FIRST.BAT (логи обновления
схем аудита, менеджера аудита; лог предоставления привилегий на объекты схемы
SYS).

2) Не должно быть ошибок установки пакетов ТЯ:
LOG\kernpkg.lst
LOG\patch.log
(кроме возможных ошибок в теле пакета stat_lib, зависящего от объектов
хранилища run_stat.mdb, после установки которого тело пакета должно
стать валидным, - см.п.16 выше).
Если при установке обновлений версии 7.4 на версию ТЯ 7.1 появились ошибки вида:
"Errors for PACKAGE BODY NUM_INTERFACE
PLS-00201: identifier 'NUM_VALUES.NEXT$' must be declared"
при этом пакет NUM_INTERFACE валидный, то ошибки считаем некритичными. Ошибки 
возникают из-за того, что установка пакета NUM_VALUES происходит после установки 
пакета NUM_INTERFACE.

3) Требуется проверить наличие логов загрузки словарей компилятора 
(SQLLDR\*.log). Признак отсутствия записей в словарях компилятора - ошибки при 
компиляции операций, в этом случае лог компиляции операций (COMPILE\IBS.OUT) 
будет состоять из ошибок вида:
BEGIN Method.Recompile('103',false); END;

*
ошибка в строке 1:
ORA-01403: no data found

4) В логах UPGRADE схемы-владельца не должно быть ошибок, связанных
с запуском сервиса LOCKINFO вида:

ORA-20300: APP-RTL: LOCK-SUBMIT: Процесс LOCK_INFO был поставлен в очередь
04:45:11 16/08/08.
Номер задания 33956, пользователь - IBS.
LOCK-LIMIT: Задание не было активизировано, возможно, из-за того, что
лимит на количество фоновых (BACKGROUND) процессов исчерпан.
Нужно увеличить этот лимит или запустить LOCK_INFO в отдельной сессии.

Также критична ошибка
ORA-01017: неверно имя пользователя/пароль; вход в систему запрещается

5) Надо проверить наличие логов вывода информации в отладочные каналы,
используемые при UPGRADE (DEBUG, DEBUG0, DEBUG1...).

6) Требуется проанализировать все файлы с логами UPGRADE на предмет характера
возникавших ошибок Oracle (искать файлы с вхождениями подстроки "ORA-").
Некритичные ошибки (см. ниже) можно пропускать.
Рекомендуется также сравнить ошибки компиляции объектов (представлений, 
операций, интерфейсных пакетов ТБП, объектов Oracle - см. каталог COMPILE, файлы
IBS.ECR, IBS.ERR, IBS.ERC, IBS_PKG.OUT), до и после выполнения UPGRADE.

Особое внимание рекомендуется обратить на наличие ошибок интерфейсных пакетов
ТБП (в файлах *.ERC) - при корректном состоянии модели данных данный файл
не должен содержать ошибок, либо в результате UPGRADE не должно появиться новых
ошибок в интерфейсных пакетах.
Если ошибки все же присутствуют, необходимо выяснить их причину - например, они
могут быть связаны с многопоточным режимом обновления.


Приложение 1 Список критичных ошибок, наличие которых говорит, что обновление
с большой вероятностью не завершено :

ORA-3113 - разрыв соединения с СУБД, потеряна связь с сервером.

Ошибки связанные с нехваткой места в табличных пространствах

ORA-1652  - нехватка места во временном табличном пространстве
ORA-1653  - нехватка места для размещения таблицы
ORA-1654  - нехватка места для размещения индекса

ORA-600, ORA-7445 - внутренние ошибки Oracle. Необходимо обратиться в 
сопровождение Oracle.

Приложение 2. Некритичные ошибки в логах обновления.

а) При выполнении UPGRADE схемы аудита производится попытка создать
primary key на таблицах diary и diary_param. Ошибку "ORA-00942: table
or view does not exist" можно игнорировать, т.к. этих таблиц не должно быть
на схеме (но они могли остаться, если не проводилась конвертация журналов
аудита).

б) Некритична ошибка ORA-20900: IBS is already present in the OWNERS list...
при выполнении AUDM.aud_mgr.add_owner('IBS');

в) Триггер  LOGOFF_TRIGGER  не  входит в базовую поставку ТЯ, но он может
быть   на   схеме,   если   установлен  функционал  ЭДО  (электронного
документооборота).  Перекомпиляция  триггера при UPGRADE производится
без   проверки  его  наличия,  поэтому ошибку ORA-04080 можно игнорировать.

г) Для каждой из ошибок ниже приводится перечень SQL Statement, при
выполнении которых ошибки можно считать некритичными:

ORA-00001: нарушено ограничение уникальности
insert

ORA-00942: таблица или представление пользователя не существует
drop table, drop view

ORA-04043: объект XXXX не существует
drop package

ORA-00955: name is already used by an existing object
create table, create index, create function

ORA-01418: заданного индекса не существует
drop index

ORA-01430: добавляемый столбец уже существует в таблице
alter table add column

ORA-01920
create user

ORA-01952: system privileges not granted to ...
revoke

ORA-02260: в таблице может быть задан только один первичный ключ
создание primary key

ORA-02264: это имя уже используется в существующем ограничении
alter table add constraint (check constraint)

ORA-02275: такое ссылочное ограничение уже есть в таблице
alter table add constraint

ORA-02443: Невозможно удалить ограничение - ограничение не существует
alter table drop constraint

ORA-04080: триггер XXXX не существует
alter trigger disable
alter trigger compile
drop trigger
