	Установка схемы менеджера аудита.

1. Перед установкой менеджера аудита AUDMGR нужно установить в true 
инициализационный параметр audit_trail и перезапустить экземпляр Oracle.

2. При переносе файлов каталога AUDMGR нужно сохранить используемую
структуру каталогов.

3. Перед запуском установки необходимо убедиться, что
на рабочей станции установлены следующие утилиты ORACLE : 
- sqlplus.exe, sqlplusw.exe (для клиента Oracle 10g)
а также прописан путь (PATH) для их запуска в текущем ENVIRONMENT. 

4. Из-под пользователя SYS нужно создать владельца схемы менеджера 
аудита c помощью FIRST.BAT (в качестве параметра нужно указать коннект-строку 
к схеме SYS). Будут запрошены имена самого владельца схемы, табличных пространств 
по умолчанию и временного для создаваемого пользователя.

5. Из-под пользователя SYS нужно создать объекты на схеме AUDM с помощью 
SECOND.BAT (в качестве параметра нужно указать коннект-строку к схеме SYS). 
Будут запрошены параметры хранения таблиц и индексов, а также имя 
пользователя-владельца IB-System-Object, который будет включен в список 
обрабатываемых схем менеджером аудита, имя схемы-ревизора (по умолчанию AUD),
дата следующего запуска добавления разделов (партиций) в журналы
аудита пользователей-владельцев в формате 'YYYY-MM-DD HH24:MI:SS'
(настройка DATE_PARTITIONS - при указании значения NO, настройка
будет удалена).

6. Из-под пользователя SYS нужно создать триггер на LOGIN пользователей 
c помощью THIRD.BAT, в качестве параметра нужно указать 
коннект-строку к схеме SYS. Будет запрошено имя владельца 
схемы менеджера аудита, где и будет создан такой триггер. 
Основной функцией триггера является инициализация контекстов 
в сессиях пользователей IBSO. Опционально можно создать триггер
на дисконнект пользовательских сессий (LOGOFF-триггер) с помощью
LOGOFF.BAT; что полезно в случае, когда сессии пользователей 
часто аварийно завершаются, не освобождая занятые ресурсы и логические 
блокировки.

7. Из-под пользователя SYS нужно запустить задание менеджера аудита 
c помощью RESTART.BAT, в качестве параметра нужно указать 
коннект-строку к схеме SYS. Будут запрошены имена - владельца схемы менеджера 
аудита и пользователя-владельца IBSO. Процесс AUD_MGR в результате успешной 
отработки скриптов должен попасть в очередь заданий Oracle и запуститься.
Этот же сценарий (RESTART.BAT) может использоваться для перезапуска 
задания менеджера аудита после, например, проведения патча схемы IBSO. 



	Комментарии к менеджеру аудита:

1. Процесс AUD_MGR не будет запускаться, если не установлен в true
системный параметр audit_trail и не включен аудит на коннекты 
пользователей (audit session).

2. Процесс AUD_MGR пишет информацию об ошибочных соединениях 
пользователей в журнал сообщений об ошибках, а информацию о
блокировке/разблокировке пользователей в журнал администратора
доступа.

3. Схема содержит таблицу SETTINGS со следующими настройками (
находящимися в колонках NAME и VALUE)
name              value
AUDITOR      Имя схемы-ревизора, где находятся журналы аудита
             (DIARY,OBJECT_STATE_HISTORY,VALUES_HISTORY).
OWNERS       Список схем IBSO (через запятую), поддерживаемых 
             менеджером аудита AUD_MGR.
TIMEOUT      Значение периода неактивности в сек. процесса AUD_MGR
             (время между сканированием таблиц системного аудита и
             таблицы USERS владельцев IBSO). Меньшее значение
             повышает оперативность получаемой информации, однако
             увеличивает нагрузку на сервер, так что ставить его
             в значение, близкое к единице не рекомендуется (значение
             по умолчанию - 10сек).
DEBUG_LEVEL  Уровень вывода отладочной информации в pipe-канал с
             именем AUD_MGR во время работы процесса:
             0 - нет вывода информации,
             1,2,3 - возрастание детализации выводимой информации.
STATUS       Текущее состояние процесса AUD_MGR, возможные значения:
             STARTED - процесс запущен,
             FINISHED - процесс завершил работу,
             TEST - самотестирование,
             STOP - запрос на остановку процесса,
             RESTART - запрос на перезапус процесса,
             HELD - процесс заморожен,
             RUN  - процесс разморожен и готов к запуску,
             сообщение об ошибке выполнения процесса при последнем запуске.
DATE_SCAN    Минимальное значение даты, за которую переносятся записи
             из таблиц системного аудита об ошибочных коннектах в журналы
             схемы-ревизора (переносятся данные с большей или равной датой). 
             При работе процесса это значение постоянно модифицируется,
             чтобы не переносились одни и те же записи.
             Формат даты: YYYY-MM-DD HH24:MI:SS.
DATE_CLEAR   Максимальное значение даты для очистки таблицы системного
             аудита (SYS.AUD$) от записей о коннектах пользовательских
             сессий. Если значение задано пустым, то такой очиcтки не
             происходит. Формат даты: DD/MM/YYYY.
KEEP_HISTORY Значение в днях хранения данных о коннектах пользователей в
             таблице системного аудита (SYS.AUD$) при установленном
             параметре DATE_CLEAR. Если текущая дата становится больше,
             чем DATE_CLEAR на 2 периода KEEP_HISTORY, то происходит
             очистка за 1 период KEEP_HISTORY и соответствующим образом
             модифицируется значение DATE_CLEAR (увеличивается на значение
             одного периода).
PROTECT*  -  Список схем (через запятую), запрещенных модификации
             менеджером аудита AUD_MGR (* означает любой символ, т.е. настроек
             может быть несколько, если список таких схем велик и не умещается
             в одну настройку). Автоматически запрещена модификация также 
             схем SYS, SYSTEM, владельцев менеджера аудита, схемы-ревизора
             и всех владельцев IBSO, перечисленных в OWNERS (т.о. перечислять
             эти схемы в настройке PROTECT не нужно).
REVOKE_NEXT_DATE
             Формула, указывающая время выполнения процедуры по отзыванию
             непосредственных прав у удаленных пользователей системы доступа. 
             В этом параметре должно быть выражение, результатом которого 
             должна быть дата в будущем. Например, для запуска в 5 утра 
             каждый день выражение может быть таким:
             trunc(sysdate) + 1 + 5/24
SUPERVISORS  Список привилегированных пользователей (через запятую), 
             при входе которых в систему рассылаются email-нотификации
             (успешный вход с кодом CONNECT, ошибочный вход с кодом BAD_CONNECT).
             Автоматически такие же сообщения рассылаются для пользователей
             с правами DBA (SYS,SYSTEM), владельцев схем Аудита (AUD), Менеджера
             аудита (AUDM), владельцев IBSO (из настройки OWNERS), при этом
             этих пользователей в настройку SUPERVISORS включать не нужно.
DATE_PARTITIONS
             Дата следующего запуска добавления разделов (партиций) в журналы
             аудита пользователей-владельцев. При наступлении указанной даты 
             (и времени, которое рекомендуется задавать так, чтобы не было активных 
             сессий пользователей) происходит добавление разделов на 6 месяцев вперед,
             после чего значение настройки модифицируется на месяц вперед. 
	     Если настройка не задана, то добавление разделов в журналы аудита
             не осуществляется.
             Формат даты: YYYY-MM-DD HH24:MI:SS.

             ВНИМАНИЕ! При добавлении разделов могут возникать ошибки, из-за которых 
             не будут созданы необходимые разделы, при этом  дата следующего 
             запуска добавления разделов, все равно будет сдвинута на месяц.
             Ошибки, возникающие в процессе добавления разделов журналируются 
             в diary3.
             Рекомендуется контролировать создание всех необходимых разделов 
	     каждый раз после наступления даты запуска добавления разделов.


ПРИМЕЧАНИЯ. 
 * Параметры DATE_SCAN и DATE_CLEAR можно модифицировать только
   при остановленном процессе AUD_MGR: при активном процессе эти значения
   модифицируются самим процессом.
 * Для ускорения сканирования таблицы системного аудита (SYS.AUD$) в
   процессе работы скриптов создается дополнительный индекс на этой
   таблице по колонке TIMESTAMP.
 * Таблица системного аудита AUD$, по умолчанию находится в табличном 
   пространстве SYSTEM, что не является оптимальным для таблиц с интенсивной 
   вставкой данных.
   При переносе таблицы AUD$ из табличного пространства SYSTEM существенно 
   снижаются активность работы с табличным пространством SYSTEM и риск 
   повреждения табличного пространства SYSTEM. В отличие от обычных 
   табличных пространств, повреждение табличного пространства SYSTEM является 
   наиболее критичным для базы данных, так как приводит к необходимости 
   полного восстановления базы данных из архивных копий. По этой причине, 
   при создании/инициализации схемы аудита, в том числе при обновлении ТЯ, 
   таблица AUD$ переносится в табличное пространство T_AUD с внутренней 
   организацией, оптимальной для таблиц с интенсивной вставкой данных. 
   Не рекомендуется вместо табличного пространства T_AUD использовать
   табличное пространство SYSTEM, т.к. в этом случае в SYSTEM будут 
   храниться данные всех таблиц аудита ТЯ и риск повреждения табличного 
   пространства SYSTEM возрастает.
 
4. Управление процессом AUD_MGR осуществляется через функции и процедуры
пакета AUD_MGR:
function  get_value(p_name varchar2) return varchar2;
    возвращает значение настройки с именем p_name.
procedure set_value(p_name varchar2, p_value varchar2);
    устанавливает значение p_value настройки p_name.
procedure get_settings(p_init boolean default false);
    считывает текущие настройки во внутренний буфер,
    если параметр p_init=true, то инициализирует отсутствующие
    настройки умолчательными значениями.
procedure add_owner(p_owner varchar2);
    добавляет нового пользователя-владельца IBSO в список для обслуживания.
procedure del_owner(p_owner varchar2);
    удаляет пользователя-владельца IBSO из списка обслуживаемых.
function  server_test return boolean;
    проверяет, активен ли процесс, возвращает true, если активен
    (функция ждет два TIMEOUTа).
procedure submit;
    ставит процесс AUD_MGR в очередь заданий (также ждет 2 TIMEOUTа,
    т.к. проверяет активность процесса).
procedure hold( p_hold boolean );
    замораживает (если p_hold=true) или размораживает (если p_hold=false)
    процесс AUD_MGR. Если процесс заморожен, то он запуститься не сможет,
    пока он не будет разморожен.
procedure stop;
    останавливает работу процесса AUD_MGR вплоть до следующего явного
    запуска или запуска через очередь заданий.
procedure run;
    процедура выполнения процесса.
procedure job ( p_job integer, p_date in out date, p_broken in out boolean );
    процедура выполнения процесса через очередь заданий.
procedure debug(p_text varchar2,p_level pls_integer default 1);
    выводит отладочное сообщение p_text в pipe-канал AUD_MGR, если
    уровень отладки p_level меньше либо равен текущему уровню (настройка
    DEBUG_LEVEL).
procedure init_contexts;
    процедура инициализирует контексты пользователя для поддерживаемых
    схем-владельцев IBSO (настройка OWNERS). Контекст инициализируется,
    если в соответствующей схеме IBSO пользователь зарегистрирован и имеет
    свойство CONTEXT (т.е. колонка properties таблицы USERS содержит
    подстроку |CONTEXT). Эта процедура используется в триггере
    на соединение пользователей с базой данных для инициализации контекстов
    пользователей для работы с IBSO.

5. Остановка процесса AUD_MGR (менеджера аудита) осуществляется командой
SQL*Plus (из-под пользователя SYS или AUDM):
    exec audm.aud_mgr.stop

6. Постановка процесса AUD_MGR в очередь заданий (запуск менеджера аудита)
осуществляется командой SQL*Plus (из-под пользователя SYS или AUDM):
    exec audm.aud_mgr.submit

7. Перезапуск процесса AUD_MGR (менеджера аудита) осуществляется командами
SQL*Plus (из-под пользователя SYS или AUDM):
    exec audm.aud_mgr.set_value('STATUS','RESTART')
    commit;


